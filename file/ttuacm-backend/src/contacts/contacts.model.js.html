<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">ttuacm-backend/src/contacts/contacts.model.js | TTUACM Backend API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ttuacm-backend/src/auth/auth.model.js~AuthModel.html">AuthModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter">AuthRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-ConfirmToken">AuthRouter-ConfirmToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-FacebookAuth">AuthRouter-FacebookAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-ForgotLogin">AuthRouter-ForgotLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-GitHubAuth">AuthRouter-GitHubAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-GitHubuthRedirect">AuthRouter-GitHubuthRedirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-GitHubuthRedirect">AuthRouter-GitHubuthRedirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-GoogleAuth">AuthRouter-GoogleAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-GoogleAuthRedirect">AuthRouter-GoogleAuthRedirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-Login">AuthRouter-Login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-Register">AuthRouter-Register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-ResetToken">AuthRouter-ResetToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AuthRouter-VerifyUser">AuthRouter-VerifyUser</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/auth/config</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-passport">passport</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/contacts</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatGroupName">formatGroupName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ContactsRouter">ContactsRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ContactsRouter">ContactsRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/email</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ttuacm-backend/src/email/email.controller.js~EmailController.html">EmailController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EmailRouter">EmailRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EmailRouter-contactUs">EmailRouter-contactUs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EmailRouter-sendChangedPasswordNotification">EmailRouter-sendChangedPasswordNotification</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EmailRouter-sendConfirmationEmail">EmailRouter-sendConfirmationEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EmailRouter-sendResetEmail">EmailRouter-sendResetEmail</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/events</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ttuacm-backend/src/events/events.controller.js~EventsController.html">EventsController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter">EventsRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter-addAttendee">EventsRouter-addAttendee</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter-getAttendees">EventsRouter-getAttendees</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter-getRawEvents">EventsRouter-getRawEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter-listEvents">EventsRouter-listEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventsRouter-removeAttendee">EventsRouter-removeAttendee</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/profile</div><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-UserRouter-getProfile">UserRouter-getProfile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-UserRouter-updateResume">UserRouter-updateResume</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-UserRouter-updateUser">UserRouter-updateUser</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ttuacm-backend/src/utils/request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectDB">connectDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateHexToken">generateHexToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateJWTToken">generateJWTToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-errorHandler">errorHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-membersOnlyRoute">membersOnlyRoute</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ttuacm-backend/src/contacts/contacts.model.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const { google } = require(&apos;googleapis&apos;);
const mongoose = require(&apos;mongoose&apos;);

const contactsSchema = mongoose.Schema({
  // User&apos;s email
  email: { type: String, required: true, unique: true },
  // User&apos;s resource name according to Google People API
  userResourceName: { type: String, default: &apos;&apos; },
  // User&apos;s etag which is used for changing data
  etag: { type: String, default: &apos;&apos; },
  // User&apos;s group resourceName
  sdcGroupResourceNames: { type: [String], default: [] },
})

/**
 * Formats the group name given to match the semester and year
 *
 * @param {string} groupName - the name for the group
 * @param {boolean} exact - whether or not to save the exact name of the group name
 */
const formatGroupName = (groupName, exact = false) =&gt; {
  let formattedName = groupName;

  if (exact) {
    console.log(&apos;saving the exact name &apos;, groupName);
  } else {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getYear();

    // May - December is considered Fall, everything else is Spring
    const season = currentMonth &gt; 4 &amp;&amp; currentMonth &lt;= 11 ? &apos;Fall&apos; : &apos;Spring&apos;;

    // Gets the last two digits of the year
    const year = currentYear.toString().slice(1, 3);

    formattedName = `SDC - ${groupName} - ${season} ${year}`;
  }

  return formattedName;
}

class ContactsModel {
  /**
   * Create the Contacts Object for the rest of the functions to use
   * @requires oAuth2Client to be defined and valid. This can be acheived by running
   * ```
   require(&apos;&lt;/path/to/&gt;oauth2.config.js&apos;).loadCredentials().```
   */
  constructor() {
    const OAuth2Client = null // TODO: Grab OAuthClient from the Auth Service
    try {
      // Google People API manager
      this.API = google.people({ version: &apos;v1&apos;, auth: OAuth2Client })
      this.DB = mongoose.model(&apos;Contacts&apos;, contactsSchema)
    } catch (err) {
      console.error(err)
      return err
    }
  }

  /**
   * Finds or creates a contact by email
   * If a user is not found in the database, we will check Google Contacts
   * If no contact is found in Google Contacts, we will create one and save
   * the data from the created contact into the database
   *
   * The important data to save is the etag, so that we can modify it later
   *
   * @param {string} email - email to add
   *
   * @return {Promise&lt;Object, Error&gt;} - a user object from the database, not from Contacts
   */
  findOrCreateContactByEmail(email) {
    return new Promise(async (resolve, reject) =&gt; {
      try {
        let userExistDb = false;
        let userExistContacts = false;

        // Check for existance of user in DB
        const user = await this.DB.findOne({ email });
        userExistDb = Boolean(user)

        // Check for existance of user in Contacts
        const connectionOptions = {
          resourceName: &apos;people/me&apos;,
          personFields: &apos;emailAddresses,memberships&apos;,
          pageSize: 2000,
        }
        const { data } = await this.API.people.connections.list(connectionOptions);
        const matchingUser = data.connections.filter((each) =&gt; {
          let exists = false;
          for (let i = 0; i &lt; each.emailAddresses.length; i += 1) {
            if (email === each.emailAddresses[i].value) {
              exists = true;
              console.log(&apos;equal&apos;);
              break;
            }
          }
          return exists;
        });
        if (matchingUser.length &gt; 0) userExistContacts = true;

        let targetUser;
        // Add the Contact to the db
        if (!userExistDb &amp;&amp; userExistContacts) {
          if (matchingUser.length &gt; 1) console.error(`Warning, there are duplicate emails`);
          console.log(&apos;cannot find user in db&apos;);
          const { resourceName, email: matchingEmail, etag } = matchingUser[0];
          const sdcGroupResourceNames = matchingUser[0].memberships.map((each) =&gt; each.contactGroupMembership.contactGroupId);
          const options = {
            email: matchingEmail,
            userResourceName: resourceName,
            etag,
            sdcGroupResourceNames,
          };
          const newUser = await (new this.DB(options)).save();
          targetUser = newUser.toObject();
          // Add the db user to Contacts and overwrite
        } else if (userExistDb &amp;&amp; !userExistContacts) {
          console.log(&apos;cannot find user in Contacts&apos;);
          const { email: userEmail } = user;
          const createContactOptions = {
            requestBody: {
              emailAddresses: [
                {
                  value: userEmail,
                },
              ],
            },
          };
          const { data: createdContact } = await this.API.people.createContact(createContactOptions);
          const query = { email: userEmail };
          const update = {
            etag: createdContact.etag,
            userResourceName: createdContact.resourceName,
          };
          const options = { new: true };
          const newUser = await this.DB.findOneAndUpdate(query, update, options);
          targetUser = newUser.toObject();
          // Create a contact and save to database
        } else if (!userExistDb &amp;&amp; !userExistContacts) {
          console.log(&apos;cannot find user anywhere&apos;);
          const createContactOptions = {
            requestBody: {
              emailAddresses: [
                {
                  value: email,
                },
              ],
            },
          };
          const { data: createdContact } = await this.API.people.createContact(createContactOptions);
          const options = {
            email,
            etag: createdContact.etag,
            userResourceName: createdContact.resourceName,
          };
          const newUser = await (new this.DB(options)).save();
          targetUser = newUser.toObject();
        } else {
          console.log(&apos;user is everywhere!&apos;);
          targetUser = user;
        }
        resolve(targetUser);
      } catch (err) {
        reject(err);
      }
    })
  }

  /**
   * Finds a group by a given name
   *
   * @param {string} name - unformatted name of the group
   * @return {Promise&lt;Object, Error&gt;} - resolves with the complete Contact Group Object
   */
  findOrCreateGroupByName(name) {
    return new Promise(async (resolve, reject) =&gt; {
      try {
        const formattedName = formatGroupName(name);
        const { data } = await this.API.contactGroups.list();
        const matchingGroups = data.contactGroups.filter(group =&gt; group.formattedName === formattedName);

        if (matchingGroups.length !== 0) {
          resolve(matchingGroups[0]);
        } else {
          const options = {
            requestBody: {
              contactGroup: {
                name: formattedName,
              },
            },
          };
          const { data: group } = await this.API.contactGroups.create(options);
          resolve(group);
        }
      } catch (err) {
        console.error(err)
        reject()
      }
    })
  }

  /**
   * Adds a user to the Contact Group - Cannot be Other - Other handled differently
   *
   * @param {string} userResourceName - the user&apos;s resourceName
   * @param {string} groupResourceName - the topic of interest
   * @param {string} otherTopic - given when the user wants a different topic
   *
   * @return {Promise&lt;Object, Error&gt;} - resolves with the complete Contact Group Object
   */
  addContactToGroup(userResourceName, groupResourceName) {
    return new Promise(async (resolve, reject) =&gt; {
      try {
        const options = {
          resourceName: groupResourceName,
          requestBody: {
            resourceNamesToAdd: [userResourceName],
          },
        };
        await this.API.contactGroups.members.modify(options);
        console.log(`Added ${userResourceName} to ${groupResourceName}`);
        resolve();
      } catch (err) {
        reject(err);
      }
    })
  }

  /**
   * Deletes the user from the groups given
   *
   * @param {string} userResourceName - the user&apos;s resourceName
   * @param {string} groupResourceNames - the group to delete from
   */
  deleteContactfromGroup(userResourceName, groupResourceName){
    return new Promise(async (resolve, reject) =&gt; {
      try {
        const options = {
          resourceName: groupResourceName,
          requestBody: {
            resourceNamesToRemove: [userResourceName],
          },
        };
        await this.API.contactGroups.members.modify(options);
        resolve();
      } catch (err) {
        reject(err);
      }
    })
  }

  /**
   * Finds a group given a name, if one is not found, we will create one
   *
   * @param {string} name - name of the group to find
   * @return {Promise&lt;Object, Error&gt;} returns the resourceName for the group
   */
  findGroupByName(name) {
    const formattedName = formatGroupName(name);
    return new Promise(async (resolve, reject) =&gt; {
      try {
        // Check for existing group
        const { data } = await this.API.contactGroups.list();
        // The list of Groups
        const { contactGroups: listOfGroups } = data;
        // Check for existing name
        const matchingGroups = listOfGroups.filter(group =&gt; group.formattedName === formattedName);

        if (matchingGroups.length !== 0) {
          resolve(matchingGroups[0].resourceName);
        } else {
          const options = {
            requestBody: {
              contactGroup: {
                name: formattedName,
              },
            },
          };
          const newGroup = await this.API.contactGroups.create(options);
          resolve(newGroup.resourceName);
        }
      } catch (err) {
        reject(err);
      }
    });
  };

  /**
   * Replace the contact&apos;s interest groups in database based on their email
   *
   * @param {string} email - user&apos;s email
   * @param {Array&lt;string&gt;} groups - resource names for the groups
   *
   * @return {Promise&lt;never&gt;}
   */
  updateContactTopics(email, groups){
    return new Promise(async (resolve, reject) =&gt; {
      console.log(&apos;updating db...&apos;);
      // TODO: not updating groups
      try {
        const query = { email };
        const update = { sdcGroupResourceNames: groups };
        const options = { new: true };
        const updatedUser = await this.DB.findOneAndUpdate(query, update, options);
        resolve(updatedUser);
      } catch (err) {
        reject(err);
      }
    })
  }
}






exports = ContactsModel
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
